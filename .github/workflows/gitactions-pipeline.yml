name: CI/CD Pipeline with GitOps

# main 브랜치에 코드가 푸시될 때 트리거됩니다.
on:
  push:
    branches: [ "main" ]
    # k8s 폴더 변경 시에는 루프 방지를 위해 트리거 제외 (선택 사항)
    paths-ignore:
      - 'k8s/**'

# Repository(YAML 파일)를 수정할 권한 부여
permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. 코드 체크아웃
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        # GitHub가 기본 제공하는 토큰 사용
        token: ${{ secrets.GITHUB_TOKEN }}

    # 2. JDK 설치
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 3. Gradle 빌드
    - name: Build with Gradle
      run: |
        chmod +x gradlew
        ./gradlew clean build

    # 4. 도커 허브 로그인 (Secret으로 등록한 도커 허브 아이디와 비밀번호 사용)
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.MY_DOCKER_USERNAME }}
        password: ${{ secrets.MY_DOCKER_PASSWORD }}

    # 5. 도커 이미지 빌드 및 푸시
    - name: Build and Push Docker Image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        # 이미지 태그를 GitHub Run Number(빌드 번호)로 설정하여 고유성 보장
        tags: ${{ secrets.MY_DOCKER_USERNAME }}/argocd-gitactions-app:${{ github.run_number }}

    # 6. GitOps: Helm values.yaml 업데이트 (Manifest Update)
    - name: Update Helm Values
      run: |
        # Linux sed 명령어로 이미지 태그 교체
        # k8s/helm/values.yaml 파일의 tag: "..." 부분을 찾아 현재 빌드 번호로 변경
        sed -i 's/tag: ".*"/tag: "${{ github.run_number }}"/g' k8s/helm/values.yaml
        # 변경 내용 확인
        cat k8s/helm/values.yaml

    # 7. 수정된 매니페스트를 다시 GitHub Push
    - name: Commit and Push Manifest changes
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add k8s/helm/values.yaml
        git commit -m "Update image tag to ${{ github.run_number }}"
        git push